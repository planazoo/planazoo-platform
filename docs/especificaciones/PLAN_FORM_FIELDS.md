# üìã Campos de Formularios de Planes

> Documento para T121: Revisi√≥n y enriquecimiento de formularios de planes

**Estado:** Borrador  
**√öltima actualizaci√≥n:** Enero 2025

> **Nota:** Los planes son la entidad principal que contiene eventos y alojamientos. Ver `docs/flujos/FLUJO_CRUD_PLANES.md` para el flujo completo.

---

## üéØ Objetivo

Definir todos los campos necesarios para formularios de creaci√≥n y edici√≥n de planes, bas√°ndonos en:
- Campos actuales del c√≥digo
- Estados del plan (Borrador, Planificando, Confirmado, En Curso, Finalizado, Cancelado)
- Mejores pr√°cticas de planificaci√≥n de viajes
- Necesidades espec√≠ficas de coordinaci√≥n grupal

---

## üìä Estructura de Navegaci√≥n

1. [Informaci√≥n B√°sica](#informaci√≥n-b√°sica)
2. [Fechas y Duraci√≥n](#fechas-y-duraci√≥n)
3. [Configuraci√≥n](#configuraci√≥n)
4. [Presupuesto](#presupuesto)
5. [Participantes](#participantes)
6. [Metadatos](#metadatos)
7. [Estados y Transiciones](#estados-y-transiciones)

---

## üîß Campos B√°sicos

### Informaci√≥n B√°sica

#### Nombre del Plan
- **Campo**: `name` (requerido)
- **Tipo**: Texto
- **Validaci√≥n**: M√≠nimo 3 caracteres, m√°ximo 100 caracteres
- **Ejemplo**: "Vacaciones Londres 2025"
- **Cuando se edita**: Siempre que el plan no est√© "Finalizado" o "Cancelado"
- **Permisos**: Solo organizador/coorganizadores

#### Descripci√≥n
- **Campo**: `description` (opcional)
- **Tipo**: Texto multil√≠nea
- **Validaci√≥n**: M√°ximo 1000 caracteres
- **Ejemplo**: "Viaje familiar de una semana a Londres con visitas culturales y tur√≠sticas"
- **Cuando se edita**: Siempre que el plan no est√© "Finalizado" o "Cancelado"
- **Permisos**: Solo organizador/coorganizadores

#### Imagen del Plan
- **Campo**: `imageUrl` (opcional)
- **Tipo**: URL de imagen subida a Firebase Storage
- **Validaci√≥n**: M√°ximo 5MB, formatos: JPG, JPEG, PNG, WEBP
- **Ejemplo**: `gs://planazoo-fd.../plans/plan123.jpg`
- **Cuando se edita**: Siempre (excepto estados bloqueados)
- **Permisos**: Solo organizador/coorganizadores
- **Ver**: `docs/ux/plan_image_management.md` para detalles t√©cnicos

---

## üìÖ Fechas y Duraci√≥n

### Fecha de Inicio
- **Campo**: `startDate` (requerido)
- **Tipo**: DateTime
- **Validaci√≥n**: Debe ser futura o presente, antes de `endDate`
- **Ejemplo**: `2025-11-15 00:00:00`
- **Cuando se edita**: 
  - Antes de "Confirmado": Libre
  - Durante "Confirmado" (<7 d√≠as): Requiere confirmaci√≥n cr√≠tica
  - Durante "En Curso": Solo ajustes mayores (ej: extender plan)
  - Despu√©s de "Finalizado": No editable
- **Permisos**: Solo organizador/coorganizadores

### Fecha de Fin
- **Campo**: `endDate` (requerido)
- **Tipo**: DateTime
- **Validaci√≥n**: Posterior a `startDate`
- **Ejemplo**: `2025-11-21 23:59:59`
- **Cuando se edita**: Mismas reglas que `startDate`
- **Permisos**: Solo organizador/coorganizadores

### Duraci√≥n
- **Campo**: Calculado autom√°ticamente
- **Tipo**: N√∫mero de d√≠as
- **C√°lculo**: `endDate - startDate + 1`
- **Ejemplo**: `7 d√≠as`
- **Visualizaci√≥n**: "15/11/2025 - 21/11/2025 (7 d√≠as)"
- **No editable**: Se deriva de fechas

### Timezone
- **Campo**: `timezone` (opcional)
- **Tipo**: String (IANA timezone)
- **Default**: Auto-detectada del organizador (ej: "Europe/Madrid")
- **Validaci√≥n**: Formato IANA v√°lido
- **Ejemplo**: "Europe/London", "America/New_York"
- **Cuando se edita**: Cualquier estado antes de "Finalizado"
- **Permisos**: Solo organizador/coorganizadores

---

## ‚öôÔ∏è Configuraci√≥n

### Visibilidad
- **Campo**: `visibility` (requerido)
- **Tipo**: Enum
- **Opciones**: 
  - "private" (Privado) - Solo participantes
  - "public" (P√∫blico) - Visible para todos
- **Default**: "private"
- **Cuando se edita**: 
  - Cambio a p√∫blico: Requiere confirmaci√≥n cr√≠tica
  - Cambio a privado: Notificar a todos los participantes
- **Permisos**: Solo organizador

### Estado del Plan
- **Campo**: `status` (requerido)
- **Tipo**: Enum
- **Opciones**: 
  - "borrador" (Borrador)
  - "planificando" (Planificando)
  - "confirmado" (Confirmado)
  - "en_curso" (En Curso)
  - "finalizado" (Finalizado)
  - "cancelado" (Cancelado)
- **Default**: "borrador"
- **Auto-avance**: 
  - "Borrador" ‚Üí "Planificando": Cuando cumple validaciones (eventos, participantes)
  - "Planificando" ‚Üí "Confirmado": Manual del organizador
  - "Confirmado" ‚Üí "En Curso": Inicio autom√°tico en `startDate`
  - "En Curso" ‚Üí "Finalizado": Final autom√°tico en `endDate`
- **Ver**: `docs/flujos/FLUJO_ESTADOS_PLAN.md` para detalles completos

---

## üí∞ Presupuesto

### Presupuesto Total
- **Campo**: `budget` (opcional)
- **Tipo**: Double (currency)
- **Validaci√≥n**: Valor positivo o null
- **Ejemplo**: `3500.00`
- **Formato visual**: "‚Ç¨3,500.00"
- **Cuando se edita**: Siempre (excepto estados bloqueados)
- **Permisos**: Solo organizador/coorganizadores

### Distribuci√≥n del Presupuesto
- **Campo**: Calculado autom√°ticamente
- **Fuente**: Suma de costes de eventos y alojamientos
- **Visualizaci√≥n**:
  - Presupuesto total: ‚Ç¨3,500
  - Distribuido: ‚Ç¨2,800
  - Restante: ‚Ç¨700
- **No editable**: Se calcula autom√°ticamente

**Ver**: `docs/flujos/FLUJO_PRESUPUESTO_PAGOS.md` para detalles completos

---

## üë• Participantes

### Organizador
- **Campo**: `userId` (autom√°tico)
- **Tipo**: String (userId del creador)
- **Asignaci√≥n**: Autom√°tica al crear el plan
- **Cambio**: Solo mediante asignaci√≥n de coorganizador
- **Permisos especiales**: Todos los permisos de escritura

### Lista de Participantes
- **Campo**: Viene de colecci√≥n `plan_participations`
- **Tipo**: Array de referencias a usuarios
- **Gesti√≥n**: A trav√©s de sistema de invitaciones (T104)
- **Roles disponibles**:
  - **organizer** (Organizador)
  - **coorganizer** (Coorganizador)
  - **participant** (Participante)
  - **observer** (Observador)

### Coorganizadores
- **Asignaci√≥n**: Por el organizador original
- **Permisos**: Casi todos los permisos del organizador
- **Excepciones**: 
  - No puede eliminar el plan
  - No puede quitar al organizador original

**Ver**: `docs/flujos/FLUJO_GESTION_PARTICIPANTES.md` para detalles completos

---

## üìä Metadatos

### ID del Plan
- **Campo**: `id` (autom√°tico)
- **Tipo**: String
- **Generaci√≥n**: Auto-generado por Firestore
- **Editable**: No (inmutable)

### UNP ID
- **Campo**: `unpId` (autom√°tico)
- **Tipo**: String
- **Prop√≥sito**: Identificador interno de UNP Calendar
- **Editable**: No

### Fecha de Creaci√≥n
- **Campo**: `createdAt` (autom√°tico)
- **Tipo**: DateTime (Timestamp)
- **Asignaci√≥n**: Al crear el plan
- **Editable**: No (inmutable)

### Fecha de √öltima Actualizaci√≥n
- **Campo**: `updatedAt` (autom√°tico)
- **Tipo**: DateTime (Timestamp)
- **Actualizaci√≥n**: Autom√°tica en cada cambio
- **Editable**: No (autom√°tico)

### Fecha de Guardado
- **Campo**: `savedAt` (autom√°tico)
- **Tipo**: DateTime (Timestamp)
- **Actualizaci√≥n**: √öltimo guardado manual del organizador
- **Prop√≥sito**: Tracking de actividad del organizador

### Contador de Columnas
- **Campo**: `columnCount` (calculado)
- **Tipo**: Int
- **C√°lculo**: Duraci√≥n en d√≠as (`endDate - startDate + 1`)
- **Prop√≥sito**: N√∫mero de columnas del calendario
- **Editable**: No (se deriva de fechas)

---

## üîÑ Estados y Transiciones

### Estado: Borrador
- **Editable**: Todo
- **Visible para**: Solo creador
- **Eliminable**: S√≠
- **Validaciones**: Ninguna
- **Pr√≥ximo estado**: "Planificando" (autom√°tico al cumplir validaciones)

### Estado: Planificando
- **Editable**: Casi todo
- **Visible para**: Solo participantes
- **Eliminable**: S√≠
- **Validaciones m√≠nimas**: 
  - Al menos 1 evento
  - Al menos 1 participante adem√°s del organizador
  - Fechas coherentes
- **Pr√≥ximo estado**: "Confirmado" (manual del organizador)

### Estado: Confirmado
- **Editable**: Ajustes menores
- **Visible para**: Todos
- **Eliminable**: Con confirmaci√≥n cr√≠tica
- **Cambios permitidos**:
  - Descripci√≥n
  - Imagen
  - Presupuesto
  - Participantes (a√±adir)
- **Cambios bloqueados**:
  - Nombre del plan
  - Fechas (sin confirmaci√≥n cr√≠tica)
  - Visibilidad a p√∫blico (sin confirmaci√≥n cr√≠tica)
- **Pr√≥ximo estado**: "En Curso" (autom√°tico en `startDate`)

### Estado: En Curso
- **Editable**: Solo urgencias
- **Visible para**: Todos
- **Eliminable**: No (solo cancelar)
- **Editable**:
  - A√±adir eventos urgentes
  - Ajustar presupuesto (registro de gastos extra)
- **Pr√≥ximo estado**: "Finalizado" (autom√°tico en `endDate`)

### Estado: Finalizado
- **Editable**: No
- **Visible para**: Todos
- **Eliminable**: No
- **Acciones permitidas**: Solo lectura, export, archivar

### Estado: Cancelado
- **Editable**: No
- **Visible para**: Todos
- **Eliminable**: No
- **Proceso**: Reembolsos autom√°ticos si hay pagos

**Ver detalles completos**: `docs/flujos/FLUJO_ESTADOS_PLAN.md`

---

## üìù Validaciones de Creaci√≥n

### Validaciones M√≠nimas
Un plan debe tener:
- ‚úÖ Nombre no vac√≠o (3-100 caracteres)
- ‚úÖ Fecha inicio presente/futura
- ‚úÖ Fecha fin posterior a inicio
- ‚úÖ Organizador asignado
- ‚úÖ Duraci√≥n m√≠nima: 1 d√≠a
- ‚úÖ Duraci√≥n m√°xima: 365 d√≠as

### Validaciones para Estado "Planificando"
Un plan pasa a "Planificando" cuando tiene:
- ‚úÖ Al menos 1 evento creado
- ‚úÖ Al menos 1 participante adem√°s del organizador
- ‚úÖ Fechas coherentes con eventos
- ‚úÖ Timezone configurado

### Validaciones para Estado "Confirmado"
El organizador puede marcar "Confirmado" cuando:
- ‚úÖ Al menos 3 eventos en el plan (recomendado)
- ‚úÖ Todos los participantes confirmaron asistencia
- ‚úÖ Presupuesto inicial estimado
- ‚úÖ Al menos 2 participantes total

---

## üé® Campos Visuales

### Imagen del Plan
**Gesti√≥n**: Ver `docs/ux/plan_image_management.md` para implementaci√≥n completa

#### Especificaciones
- **Tama√±o m√°ximo**: 5MB
- **Formatos**: JPG, JPEG, PNG, WEBP
- **Almacenamiento**: Firebase Storage
- **Ruta**: `gs://.../plans/{planId}/{timestamp}.{ext}`

#### Proceso de carga
1. Usuario selecciona imagen desde galer√≠a
2. Validaci√≥n autom√°tica de tama√±o y formato
3. Compresi√≥n inteligente (si >2MB)
4. Subida a Firebase Storage
5. Actualizaci√≥n de `imageUrl` en Firestore
6. Previsualizaci√≥n inmediata

#### Ubicaciones de visualizaci√≥n
- **Dashboard (W5)**: Foto circular del plan seleccionado
- **Lista de planes (W28)**: Imagen peque√±a en card
- **Info del plan**: Imagen grande con opci√≥n de edici√≥n

---

## ü§î DECISIONES PENDIENTES

### T√©cnicas
- [ ] ¬øImplementar versiones/backups autom√°ticos del plan?
- [ ] ¬øSistema de historial de cambios para planes?
- [ ] ¬øCampos personalizados por tipo de plan (vacaciones, boda, trabajo)?
- [ ] ¬øL√≠mite de planes por usuario?

### UX
- [ ] ¬øPlantillas predefinidas por categor√≠a?
- [ ] ¬øAsistente de creaci√≥n paso a paso?
- [ ] ¬øB√∫squeda de planes similares?
- [ ] ¬øExportar plan completo (PDF, Excel, JSON)?

### Datos
- [ ] ¬øIntegraci√≥n con Google Calendar para sincronizaci√≥n?
- [ ] ¬øSistema de backup en cloud del usuario?
- [ ] ¬øAlertas proactivas de cambios importantes?
- [ ] ¬øEstad√≠sticas de uso del plan?

---

*Documento creado para T121 - Revisi√≥n y enriquecimiento de formularios*  
*√öltima actualizaci√≥n: Enero 2025*


